name: E2E Tests

on:
  push:
    branches: [main]
    paths:
      - '**.rs'
      - '**/Cargo.toml'
      - '**/Cargo.lock'
      - 'tests/**'
      - '.github/workflows/e2e.yml'
  pull_request:
    branches: [main]
    paths:
      - '**.rs'
      - '**/Cargo.toml'
      - '**/Cargo.lock'
      - 'tests/**'
      - '.github/workflows/e2e.yml'
  workflow_dispatch:

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  RUST_BACKTRACE: 1
  RUST_LOG: debug

jobs:
  # Build once, test multiple ways
  build:
    name: Build Release Binary
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - name: Build release binary
        run: cargo build --release

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: ms-binary
          path: target/release/ms
          retention-days: 1

  e2e:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: ms-binary
          path: bin

      - name: Setup binary
        run: |
          chmod +x bin/ms
          echo "$PWD/bin" >> $GITHUB_PATH

      - name: Run E2E tests
        id: e2e
        run: |
          cargo test --test '*' -- --nocapture 2>&1 | tee e2e-output.log
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: E2E Summary
        if: always()
        run: |
          echo "## E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f e2e-output.log ]; then
            # Count passed/failed
            PASSED=$(grep -c "test .* ok" e2e-output.log 2>/dev/null || echo "0")
            FAILED=$(grep -c "test .* FAILED" e2e-output.log 2>/dev/null || echo "0")
            echo "- **Passed**: $PASSED" >> $GITHUB_STEP_SUMMARY
            echo "- **Failed**: $FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "$FAILED" -gt 0 ]; then
              echo "### Failed Tests" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep "test .* FAILED" e2e-output.log >> $GITHUB_STEP_SUMMARY || true
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Upload E2E logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-logs
          path: |
            e2e-output.log
            tests/e2e/*.log
          retention-days: 7

  robot-mode:
    name: Robot Mode Validation
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: ms-binary
          path: bin

      - name: Setup binary
        run: |
          chmod +x bin/ms
          echo "$PWD/bin" >> $GITHUB_PATH

      - name: Test robot mode JSON output
        id: robot
        run: |
          # Create isolated test directory
          TEMP_MS=$(mktemp -d)
          cd "$TEMP_MS"

          TESTS_PASSED=0
          TESTS_FAILED=0

          run_robot_test() {
            local name="$1"
            local cmd="$2"
            local output_file="$3"
            local jq_check="${4:-.}"

            echo "::group::Testing: $name"
            echo "Command: $cmd"

            if eval "$cmd" 2>&1 | tee "$output_file"; then
              if jq -e "$jq_check" "$output_file" > /dev/null 2>&1; then
                echo "::endgroup::"
                echo ":white_check_mark: $name" >> "$GITHUB_STEP_SUMMARY"
                TESTS_PASSED=$((TESTS_PASSED + 1))
                return 0
              fi
            fi
            echo "::endgroup::"
            echo ":x: $name - invalid JSON output" >> "$GITHUB_STEP_SUMMARY"
            TESTS_FAILED=$((TESTS_FAILED + 1))
            return 1
          }

          echo "## Robot Mode Tests" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Run tests (continue on individual failures)
          run_robot_test "ms init --robot" "ms init --robot" "init.json" ".status" || true
          run_robot_test "ms doctor --robot" "ms doctor --robot" "doctor.json" || true
          run_robot_test "ms search --robot" "ms search 'test' --robot" "search.json" || true

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Passed**: $TESTS_PASSED / $((TESTS_PASSED + TESTS_FAILED))" >> "$GITHUB_STEP_SUMMARY"

          # Exit with failure if any tests failed
          if [ "$TESTS_FAILED" -gt 0 ]; then
            echo "Some robot mode tests failed"
            exit 1
          fi

          echo "All robot mode tests passed!"

      - name: Upload robot mode logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: robot-mode-logs
          path: |
            *.json
          retention-days: 7

  # Matrix test across platforms
  cross-platform:
    name: Cross-Platform (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - name: Build release binary
        run: cargo build --release

      - name: Run quick smoke test
        shell: bash
        run: |
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            ./target/release/ms.exe --version
            ./target/release/ms.exe --help
          else
            ./target/release/ms --version
            ./target/release/ms --help
          fi

  # Final status check for branch protection
  e2e-success:
    name: E2E Success
    if: always()
    needs: [e2e, robot-mode, cross-platform]
    runs-on: ubuntu-latest
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ needs.e2e.result }}" != "success" ]] || \
             [[ "${{ needs.robot-mode.result }}" != "success" ]] || \
             [[ "${{ needs.cross-platform.result }}" != "success" ]]; then
            echo "One or more E2E jobs failed"
            exit 1
          fi
          echo "All E2E jobs passed!"
